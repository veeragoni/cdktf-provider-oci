# ~~ Generated by projen. To modify, edit .projenrc.js and run "npx projen".

name: check-provider-updates
on:
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch: {}
jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Check for OCI Provider updates
        id: check
        run: "

          \        # Get current version from package.json or provider config

          \        CURRENT_VERSION=$(grep -oP '\"terraformProvider\":\\s*\"oracle/oci@~>\\s*\\K[0-9]+\\.[0-9]+' .projenrc.ts || echo \"6.0\")


          \        # Get latest OCI provider version from Terraform Registry

          \        LATEST_VERSION=$(curl -s https://registry.terraform.io/v1/providers/oracle/oci | jq -r '.version' | cut -d. -f1,2)


          \        echo \"Current version: $CURRENT_VERSION\"

          \        echo \"Latest version: $LATEST_VERSION\"


          \        if [ \"$CURRENT_VERSION\" != \"$LATEST_VERSION\" ]; then

          \          echo \"update_needed=true\" >> $GITHUB_OUTPUT

          \          echo \"latest_version=$LATEST_VERSION\" >> $GITHUB_OUTPUT

          \        else

          \          echo \"update_needed=false\" >> $GITHUB_OUTPUT

          \        fi

          \      "
      - name: Generate provider bindings
        if: steps.check.outputs.update_needed == 'true'
        run: "

          \        # Update provider version in configuration

          \        LATEST_VERSION=${{ steps.check.outputs.latest_version }}


          \        # Generate new provider bindings

          \        npx cdktf-cli@latest get --language typescript --provider \"oracle/oci@~> $LATEST_VERSION\"


          \        # Update .projenrc.ts with new version

          \        sed -i \"s/oracle\\/oci@~>[^']*/oracle\\/oci@~> $LATEST_VERSION/\" .projenrc.ts


          \        # Run projen to update project files

          \        npx projen

          \      "
      - name: Create Pull Request
        if: steps.check.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update OCI provider to v${{ steps.check.outputs.latest_version }}"
          title: "chore: update OCI provider to v${{ steps.check.outputs.latest_version }}"
          body: |-
            This PR updates the OCI Terraform provider to version ${{ steps.check.outputs.latest_version }}.

            ## Changes
            - Updated provider bindings to oracle/oci@~> ${{ steps.check.outputs.latest_version }}
            - Regenerated TypeScript bindings
            - Updated dependencies

            ## Release Notes
            Check the [OCI Provider Release Notes](https://github.com/oracle/terraform-provider-oci/releases) for details.

            ---
            *This PR was automatically created by the check-provider-updates workflow.*
          branch: update-oci-provider-${{ steps.check.outputs.latest_version }}
          delete-branch: true
          labels: dependencies,automated
